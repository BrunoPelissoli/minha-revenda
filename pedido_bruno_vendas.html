<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bruno Vendas — Pedido</title>

<style>
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  margin:0;
  background:#000;
  color:#f5f5f5;
}

.wrap{
  max-width:900px;
  margin:0 auto;
  padding:20px;
}

h2{
  margin:8px 0 20px;
  font-size:26px;
}

.card{
  background:#0b0b0c;
  border:1px solid #18181b;
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
}

.row{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

input,button{
  font-size:16px;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid #18181b;
  background:#000;
  color:#fff;
}

button{
  cursor:pointer;
  background:#2563eb;
  border:0;
}

button:hover{
  background:#1d4ed8;
}

.prod{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 0;
  border-bottom:1px solid #18181b;
}

.prod:last-child{
  border-bottom:0;
}

.muted{
  color:#a1a1aa;
}

.total{
  font-size:20px;
  font-weight:900;
}
</style>
</head>

<body>
<div class="wrap">

<h2>Bruno <span style="color:#3b82f6">Vendas</span> — Pedido</h2>

<div class="card">
  <div class="row">
    <input id="nome" placeholder="Seu nome" style="flex:1;min-width:220px">
    <input id="whatsapp" placeholder="WhatsApp" style="flex:1;min-width:200px">
  </div>
  <div style="margin-top:12px">
    <input id="obs" placeholder="Observação (opcional)" style="width:100%">
  </div>
  <input id="website" style="display:none" autocomplete="off">
</div>

<div class="card">
  <div style="font-weight:800;margin-bottom:12px">Produtos disponíveis</div>
  <div id="lista" class="muted">Carregando...</div>
</div>

<div class="card">
  <div class="row" style="justify-content:space-between;align-items:center">
    <div>Total: <span id="total" class="total">R$ 0,00</span></div>
    <button onclick="enviar()">Enviar pedido</button>
  </div>
  <div id="msg" class="muted" style="margin-top:10px"></div>
</div>

</div>

<script>
const BASE = "https://bnsdsipilwcoipaqavfv.functions.supabase.co";

let catalogo = [];

const fmt = n => (Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

async function carregar(){
  try{
    const r = await fetch(`${BASE}/catalogo`);
    const j = await r.json();
    catalogo = j.produtos || [];
    render();
  }catch(e){
    document.getElementById('lista').textContent = "Erro ao carregar produtos.";
  }
}

function render(){
  const el = document.getElementById('lista');
  if(!catalogo.length){
    el.textContent = "Sem produtos disponíveis no momento.";
    return;
  }

  el.innerHTML = "";
  catalogo.forEach(p=>{
    const div = document.createElement('div');
    div.className='prod';
    div.innerHTML = `
      <div>
        <div style="font-weight:800">${p.nome}</div>
        <div class="muted">${fmt(p.preco)} — estoque: ${p.estoque}</div>
      </div>
      <div>
        <input type="number" min="0" max="${p.estoque}" value="0"
        style="width:90px"
        data-nome="${p.nome}"
        data-preco="${p.preco}"
        oninput="recalcular()">
      </div>
    `;
    el.appendChild(div);
  });

  recalcular();
}

function recalcular(){
  let total = 0;
  document.querySelectorAll('input[type="number"][data-nome]').forEach(inp=>{
    const qtd = Math.floor(Number(inp.value||0));
    const preco = Number(inp.dataset.preco||0);
    total += (qtd>0 ? qtd*preco : 0);
  });
  document.getElementById('total').textContent = fmt(total);
}

async function enviar(){
  const nome = document.getElementById('nome').value.trim();
  const whatsapp = document.getElementById('whatsapp').value.trim();
  const observacao = document.getElementById('obs').value.trim();
  const website = document.getElementById('website').value;

  const itens = [];
  document.querySelectorAll('input[type="number"][data-nome]').forEach(inp=>{
    const qtd = Math.floor(Number(inp.value||0));
    if(qtd>0){
      itens.push({ nome: inp.dataset.nome, qtd });
    }
  });

  const msg = document.getElementById('msg');
  msg.textContent = "";

  if(!nome || !whatsapp || !itens.length){
    msg.textContent = "Preencha nome, WhatsApp e selecione ao menos 1 produto.";
    return;
  }

  try{
    const r = await fetch(`${BASE}/pedido`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ nome, whatsapp, observacao, itens, website })
    });

    const j = await r.json();

    if(!r.ok || !j.ok){
      msg.textContent = j.error || "Erro ao enviar pedido.";
      return;
    }

    msg.textContent = `Pedido enviado com sucesso! Nº ${j.pedido_id}`;
  }catch(e){
    msg.textContent = "Erro de conexão.";
  }
}

carregar();
</script>

</body>
</html>
